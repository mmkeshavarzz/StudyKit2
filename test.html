<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª StudyKit - Database Test v4.0</title>
    <style>
        /* ========================================
         * StudyKit Connection Tester v4.0
         * ØªÙ…: ØµØ¯ÙÛŒ + Ù¾Ø§Ø³ØªÛŒÙ„ÛŒ + Ú¯Ù„Ø³Ù…ÙˆØ±ÙÛŒØ³Ù…
         * ØªØ§Ø±ÛŒØ®: 1404/12/08
         * ======================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            direction: rtl;
            min-height: 100vh;
            /* Ú¯Ø±Ø§Ø¯ÛŒØ§Ù† ØµØ¯ÙÛŒ Ù¾Ø§Ø³ØªÛŒÙ„ÛŒ */
            background: linear-gradient(135deg, #fef9f3 0%, #f0e6ff 30%, #e6f7ff 60%, #fff5f5 100%);
            padding: 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
        }
        
        /* Ù‡Ø¯Ø± Ø§ØµÙ„ÛŒ - Ú¯Ù„Ø³Ù…ÙˆØ±ÙÛŒØ³Ù… */
        .header {
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(149, 128, 255, 0.1);
        }
        
        .header h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #7c5cfc, #ff6b9d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #8b7fa8;
            font-size: 0.95rem;
        }
        
        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #a78bfa, #7c5cfc);
            color: white;
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-top: 10px;
            letter-spacing: 0.5px;
        }
        
        /* Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ ØªØ³Øª */
        .start-btn {
            display: block;
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            margin-bottom: 25px;
            background: linear-gradient(135deg, #7c5cfc, #a78bfa);
            box-shadow: 0 6px 25px rgba(124, 92, 252, 0.35);
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 35px rgba(124, 92, 252, 0.5);
        }
        
        .start-btn:active {
            transform: translateY(0);
        }
        
        .start-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ ØªØ³Øª - Ù†Ø¦ÙˆÙ…ÙˆØ±ÙÛŒØ³Ù… + Ú¯Ù„Ø³Ù…ÙˆØ±ÙÛŒØ³Ù… */
        .test-card {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.4s ease;
            box-shadow:
                6px 6px 14px rgba(180, 170, 200, 0.15),
                -4px -4px 10px rgba(255, 255, 255, 0.7);
        }
        
        .test-card.running {
            border-color: rgba(167, 139, 250, 0.5);
            box-shadow: 0 0 20px rgba(167, 139, 250, 0.15);
        }
        
        .test-card.pass {
            border-color: rgba(74, 222, 128, 0.5);
            background: rgba(240, 255, 244, 0.5);
        }
        
        .test-card.fail {
            border-color: rgba(252, 129, 129, 0.5);
            background: rgba(255, 240, 240, 0.5);
        }
        
        .test-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .test-title {
            font-size: 1rem;
            font-weight: 600;
            color: #4a3f6b;
        }
        
        .test-status {
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .status-waiting {
            background: rgba(226, 222, 240, 0.5);
            color: #9b8fc4;
        }
        
        .status-running {
            background: rgba(167, 139, 250, 0.2);
            color: #7c5cfc;
            animation: pulse 1.2s infinite;
        }
        
        .status-pass {
            background: rgba(74, 222, 128, 0.2);
            color: #16a34a;
        }
        
        .status-fail {
            background: rgba(252, 129, 129, 0.2);
            color: #dc2626;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .test-detail {
            font-size: 0.85rem;
            color: #7b7194;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        /* Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬ */
        .summary-card {
            background: rgba(255, 255, 255, 0.55);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 24px;
            padding: 25px;
            margin-top: 20px;
            text-align: center;
            display: none;
            box-shadow:
                8px 8px 18px rgba(180, 170, 200, 0.12),
                -6px -6px 14px rgba(255, 255, 255, 0.8);
        }
        
        .summary-card.visible { display: block; }
        
        .summary-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #4a3f6b;
        }
        
        .score-display {
            font-size: 3rem;
            font-weight: 800;
            margin: 10px 0;
        }
        
        .score-display.perfect {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .score-display.good {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .score-display.bad {
            background: linear-gradient(135deg, #f87171, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .summary-detail {
            color: #8b7fa8;
            font-size: 0.95rem;
            margin-top: 10px;
            line-height: 1.8;
        }
        
        /* Ø¬Ø¯ÙˆÙ„ Ø³Ø§Ø®ØªØ§Ø± */
        .schema-section {
            margin-top: 20px;
            display: none;
        }
        
        .schema-section.visible { display: block; }
        
        .schema-table-title {
            font-size: 1rem;
            font-weight: 700;
            color: #7c5cfc;
            margin: 15px 0 8px;
            padding: 8px 16px;
            background: rgba(124, 92, 252, 0.08);
            border-radius: 12px;
            display: inline-block;
        }
        
        .schema-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 12px;
            font-size: 0.82rem;
            border: 1px solid rgba(200, 190, 220, 0.3);
        }
        
        .schema-table th {
            background: rgba(167, 139, 250, 0.12);
            color: #5b4f80;
            padding: 10px 12px;
            text-align: right;
            font-weight: 600;
        }
        
        .schema-table td {
            padding: 8px 12px;
            border-top: 1px solid rgba(200, 190, 220, 0.15);
            color: #6b5f8a;
        }
        
        .schema-table tr:hover td {
            background: rgba(167, 139, 250, 0.04);
        }
        
        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .type-uuid { background: #ede9fe; color: #7c3aed; }
        .type-text { background: #fef3c7; color: #d97706; }
        .type-int { background: #dbeafe; color: #2563eb; }
        .type-bool { background: #d1fae5; color: #059669; }
        .type-date { background: #ffe4e6; color: #e11d48; }
        .type-ts { background: #f3e8ff; color: #9333ea; }
        
        /* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
        @media (max-width: 480px) {
            body { padding: 12px; }
            .header h1 { font-size: 1.4rem; }
            .test-card { padding: 16px; }
            .score-display { font-size: 2.2rem; }
            .schema-table { font-size: 0.75rem; }
            .schema-table th, .schema-table td { padding: 6px 8px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Ù‡Ø¯Ø± -->
        <div class="header">
            <h1>ğŸ§ª StudyKit Connection Tester</h1>
            <p>Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ Ú©Ø§Ù…Ù„ Ø¨Ù‡ Supabase Ùˆ Ø³Ø§Ø®ØªØ§Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³</p>
            <span class="version-badge">v4.0 â€” Matched Schema</span>
        </div>

        <!-- Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ -->
        <button class="start-btn" id="startBtn">ğŸš€ Ø´Ø±ÙˆØ¹ ØªØ³Øªâ€ŒÙ‡Ø§</button>

        <!-- Ú©Ø§Ø±Øª ØªØ³Øª Û± -->
        <div class="test-card" id="test1">
            <div class="test-header">
                <span class="test-title">Û±. Ø³Ø§Ø®Øª Supabase Client</span>
                <span class="test-status status-waiting" id="status1">â³ Ù…Ù†ØªØ¸Ø±</span>
            </div>
            <div class="test-detail" id="detail1">Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Supabase Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø´Ù‡ Ùˆ Client Ø³Ø§Ø®ØªÙ‡ Ø¨Ø´Ù‡...</div>
        </div>

        <!-- Ú©Ø§Ø±Øª ØªØ³Øª Û² -->
        <div class="test-card" id="test2">
            <div class="test-header">
                <span class="test-title">Û². Ù¾ÛŒÙ†Ú¯ Ø³Ø±ÙˆØ± Supabase</span>
                <span class="test-status status-waiting" id="status2">â³ Ù…Ù†ØªØ¸Ø±</span>
            </div>
            <div class="test-detail" id="detail2">Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø³Ø±ÙˆØ± Ùˆ Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ø³Ø®...</div>
        </div>

        <!-- Ú©Ø§Ø±Øª ØªØ³Øª Û³ -->
        <div class="test-card" id="test3">
            <div class="test-header">
                <span class="test-title">Û³. Ø¨Ø±Ø±Ø³ÛŒ Ø¬Ø¯Ø§ÙˆÙ„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³</span>
                <span class="test-status status-waiting" id="status3">â³ Ù…Ù†ØªØ¸Ø±</span>
            </div>
            <div class="test-detail" id="detail3">Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ø¯Ø§ÙˆÙ„: users, study_logs, plans, goals...</div>
        </div>

        <!-- Ú©Ø§Ø±Øª ØªØ³Øª Û´ -->
        <div class="test-card" id="test4">
            <div class="test-header">
                <span class="test-title">Û´. Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø±ÙˆÛŒØ³ Auth</span>
                <span class="test-status status-waiting" id="status4">â³ Ù…Ù†ØªØ¸Ø±</span>
            </div>
            <div class="test-detail" id="detail4">Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Supabase...</div>
        </div>

        <!-- Ú©Ø§Ø±Øª ØªØ³Øª Ûµ -->
        <div class="test-card" id="test5">
            <div class="test-header">
                <span class="test-title">Ûµ. Ø¨Ø±Ø±Ø³ÛŒ RLS (Ø§Ù…Ù†ÛŒØª Ø³Ø·Ø±)</span>
                <span class="test-status status-waiting" id="status5">â³ Ù…Ù†ØªØ¸Ø±</span>
            </div>
            <div class="test-detail" id="detail5">Ø¨Ø±Ø±Ø³ÛŒ ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Row Level Security...</div>
        </div>

        <!-- Ú©Ø§Ø±Øª ØªØ³Øª Û¶ -->
        <div class="test-card" id="test6">
            <div class="test-header">
                <span class="test-title">Û¶. Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø³ØªÙˆÙ†â€ŒÙ‡Ø§</span>
                <span class="test-status status-waiting" id="status6">â³ Ù…Ù†ØªØ¸Ø±</span>
            </div>
            <div class="test-detail" id="detail6">Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù‡Ø± Ø¬Ø¯ÙˆÙ„ Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±...</div>
        </div>

        <!-- Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬ -->
        <div class="summary-card" id="summary">
            <div class="summary-title" id="summaryTitle">ğŸ“Š Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</div>
            <div class="score-display" id="scoreDisplay">-/-</div>
            <div class="summary-detail" id="summaryDetail"></div>
        </div>

        <!-- Ø¨Ø®Ø´ Ù†Ù…Ø§ÛŒØ´ Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯Ø§ÙˆÙ„ -->
        <div class="schema-section" id="schemaSection"></div>
    </div>

    <!-- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Supabase JS Ø§Ø² CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <script>
        /**
         * =============================================
         *  StudyKit Connection Tester v4.0
         *  ØªØ§Ø±ÛŒØ®: 1404/12/08
         *  Ø³Ø§Ø®ØªØ§Ø±: Ù…Ø·Ø§Ø¨Ù‚ Ø¨Ø§ Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù‚Ø¹ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡
         * =============================================
         */

        /* ---------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØªØµØ§Ù„ ---------- */
        var SUPABASE_URL = 'https://nkxteuknthhwjvvztmhz.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5reHRldWtudGhod2p2dnp0bWh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MjYwMDEsImV4cCI6MjA1NjEwMjAwMX0.aCxIfmDM4bMBBBRBBq0RqJpGrJoBLMQ4JpJHSjiBsNI';

        /* ---------- Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ø¯Ø§ÙˆÙ„ ---------- */
        var EXPECTED_SCHEMA = {
            users: ['id', 'created_at', 'email', 'full_name', 'avatar_url'],
            study_logs: ['id', 'user_id', 'subject', 'duration_minutes', 'study_date', 'note', 'created_at', 'notes'],
            plans: ['id', 'user_id', 'title', 'description', 'start_date', 'end_date', 'is_active', 'created_at'],
            goals: ['id', 'user_id', 'title', 'target_hours', 'current_hours', 'deadline', 'is_completed', 'created_at']
        };

        var TABLE_NAMES = Object.keys(EXPECTED_SCHEMA);
        var sbClient = null;
        var testResults = [];

        /* ---------- Ø§Ø¨Ø²Ø§Ø± Ú©Ù…Ú©ÛŒ DOM ---------- */
        function setStatus(n, cls, text) {
            var el = document.getElementById('status' + n);
            el.className = 'test-status status-' + cls;
            el.textContent = text;
            document.getElementById('test' + n).className = 'test-card ' + (cls === 'running' ? 'running' : cls === 'pass' ? 'pass' : cls === 'fail' ? 'fail' : '');
        }

        function setDetail(n, msg) {
            document.getElementById('detail' + n).textContent = msg;
        }

        function sleep(ms) {
            return new Promise(function (r) { setTimeout(r, ms); });
        }

        /* ===========================================
         *  ØªØ³Øª Û±: Ø³Ø§Ø®Øª Client
         * =========================================== */
        async function runTest1() {
            setStatus(1, 'running', 'ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...');
            await sleep(500);

            try {
                if (typeof window.supabase === 'undefined' && typeof window.Supabase === 'undefined') {
                    throw new Error('Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Supabase Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡!');
                }

                var factory = (window.supabase && window.supabase.createClient)
                    ? window.supabase.createClient
                    : (window.Supabase && window.Supabase.createClient)
                        ? window.Supabase.createClient
                        : null;

                if (!factory) throw new Error('ØªØ§Ø¨Ø¹ createClient Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!');

                sbClient = factory(SUPABASE_URL, SUPABASE_ANON_KEY);

                if (!sbClient) throw new Error('Client Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯!');

                setStatus(1, 'pass', 'âœ… Ù…ÙˆÙÙ‚');
                setDetail(1, 'âœ… Supabase Client Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯.\nğŸ”— URL: ' + SUPABASE_URL.replace('https://', '').slice(0, 25) + '...');
                return true;

            } catch (err) {
                setStatus(1, 'fail', 'âŒ Ø®Ø·Ø§');
                setDetail(1, 'âŒ ' + err.message);
                return false;
            }
        }

        /* ===========================================
         *  ØªØ³Øª Û²: Ù¾ÛŒÙ†Ú¯ Ø³Ø±ÙˆØ±
         * =========================================== */
        async function runTest2() {
            setStatus(2, 'running', 'ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...');
            await sleep(400);

            try {
                if (!sbClient) throw new Error('Client ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!');

                var startTime = performance.now();
                var resp = await fetch(SUPABASE_URL + '/rest/v1/', {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
                    }
                });
                var ping = Math.round(performance.now() - startTime);

                if (!resp.ok) throw new Error('Ø³Ø±ÙˆØ± Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯ ÙˆÙ„ÛŒ Ø¨Ø§ Ø®Ø·Ø§: HTTP ' + resp.status);

                setStatus(2, 'pass', 'âœ… Ù…ÙˆÙÙ‚');
                setDetail(2, 'âœ… Ø³Ø±ÙˆØ± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª!\nâ±ï¸ Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø®: ' + ping + 'ms\nğŸ“¡ Status: ' + resp.status);
                return true;

            } catch (err) {
                setStatus(2, 'fail', 'âŒ Ø®Ø·Ø§');
                setDetail(2, 'âŒ ' + err.message);
                return false;
            }
        }

        /* ===========================================
         *  ØªØ³Øª Û³: Ø¨Ø±Ø±Ø³ÛŒ Ø¬Ø¯Ø§ÙˆÙ„
         * =========================================== */
        async function runTest3() {
            setStatus(3, 'running', 'ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...');
            await sleep(400);

            try {
                if (!sbClient) throw new Error('Client ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!');

                var found = [];
                var missing = [];

                for (var i = 0; i < TABLE_NAMES.length; i++) {
                    var tbl = TABLE_NAMES[i];
                    var result = await sbClient.from(tbl).select('*').limit(0);

                    if (result.error) {
                        missing.push(tbl + ' (' + result.error.message.slice(0, 60) + ')');
                    } else {
                        found.push(tbl);
                    }
                }

                var msg = 'ğŸ“‹ Ø¬Ø¯Ø§ÙˆÙ„ ÛŒØ§ÙØª Ø´Ø¯Ù‡: ' + found.length + '/' + TABLE_NAMES.length + '\n';
                msg += found.map(function (t) { return '  âœ… ' + t; }).join('\n');

                if (missing.length > 0) {
                    msg += '\n\nâŒ Ø¬Ø¯Ø§ÙˆÙ„ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯Ù‡:\n';
                    msg += missing.map(function (t) { return '  â›” ' + t; }).join('\n');
                }

                if (missing.length === 0) {
                    setStatus(3, 'pass', 'âœ… Ù…ÙˆÙÙ‚');
                    setDetail(3, msg);
                    return true;
                } else {
                    setStatus(3, 'fail', 'âŒ Ø®Ø·Ø§');
                    setDetail(3, msg);
                    return false;
                }

            } catch (err) {
                setStatus(3, 'fail', 'âŒ Ø®Ø·Ø§');
                setDetail(3, 'âŒ ' + err.message);
                return false;
            }
        }

        /* ===========================================
         *  ØªØ³Øª Û´: Ø¨Ø±Ø±Ø³ÛŒ Auth
         * =========================================== */
        async function runTest4() {
            setStatus(4, 'running', 'ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...');
            await sleep(400);

            try {
                if (!sbClient) throw new Error('Client ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!');

                var authResult = await sbClient.auth.getSession();

                if (authResult.error) throw new Error(authResult.error.message);

                var session = authResult.data.session;
                var msg = 'âœ… Ø³Ø±ÙˆÛŒØ³ Auth Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª!\n';
                msg += session
                    ? 'ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± Ù„Ø§Ú¯ÛŒÙ† Ø´Ø¯Ù‡: ' + (session.user.email || session.user.id)
                    : 'ğŸ”“ Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ù†ÛŒØ³Øª (Ø¹Ø§Ø¯ÛŒ Ø§Ø³Øª)';

                setStatus(4, 'pass', 'âœ… Ù…ÙˆÙÙ‚');
                setDetail(4, msg);
                return true;

            } catch (err) {
                setStatus(4, 'fail', 'âŒ Ø®Ø·Ø§');
                setDetail(4, 'âŒ ' + err.message);
                return false;
            }
        }

        /* ===========================================
         *  ØªØ³Øª Ûµ: Ø¨Ø±Ø±Ø³ÛŒ RLS
         * =========================================== */
        async function runTest5() {
            setStatus(5, 'running', 'ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...');
            await sleep(400);

            try {
                if (!sbClient) throw new Error('Client ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!');

                var rlsResults = [];

                for (var i = 0; i < TABLE_NAMES.length; i++) {
                    var tbl = TABLE_NAMES[i];
                    var res = await sbClient.from(tbl).select('*').limit(1);

                    if (res.error && res.error.code === '42501') {
                        rlsResults.push('  ğŸ”’ ' + tbl + ' â€” RLS ÙØ¹Ø§Ù„ (Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯ Ø¨Ø¯ÙˆÙ† Ù„Ø§Ú¯ÛŒÙ†)');
                    } else if (res.data && res.data.length === 0) {
                        rlsResults.push('  ğŸ”’ ' + tbl + ' â€” RLS ÙØ¹Ø§Ù„ (Ø¯Ø§Ø¯Ù‡ Ø®Ø§Ù„ÛŒ = ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡)');
                    } else if (res.error) {
                        rlsResults.push('  âš ï¸ ' + tbl + ' â€” Ø®Ø·Ø§: ' + res.error.message.slice(0, 50));
                    } else {
                        rlsResults.push('  âš ï¸ ' + tbl + ' â€” Ù…Ù…Ú©Ù†Ù‡ RLS ØºÛŒØ±ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ù‡!');
                    }
                }

                var msg = 'ğŸ›¡ï¸ Ù†ØªØ§ÛŒØ¬ Ø¨Ø±Ø±Ø³ÛŒ RLS:\n' + rlsResults.join('\n');
                setStatus(5, 'pass', 'âœ… Ù…ÙˆÙÙ‚');
                setDetail(5, msg);
                return true;

            } catch (err) {
                setStatus(5, 'fail', 'âŒ Ø®Ø·Ø§');
                setDetail(5, 'âŒ ' + err.message);
                return false;
            }
        }

        /* ===========================================
         *  ØªØ³Øª Û¶: Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø³ØªÙˆÙ†â€ŒÙ‡Ø§
         * =========================================== */
        async function runTest6() {
            setStatus(6, 'running', 'ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...');
            await sleep(400);

            try {
                if (!sbClient) throw new Error('Client ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!');

                /* Ø¨Ø±Ø§ÛŒ Ú†Ú© Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ØŒ ÛŒÚ© SELECT Ù…ÛŒØ²Ù†ÛŒÙ… Ùˆ 
                   Ø§Ø² header Ù‡Ø§ÛŒ response Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒÚ©Ù†ÛŒÙ….
                   Ø§Ú¯Ù‡ Ø®Ø·Ø§ÛŒÛŒ Ø¨Ø¯Ù‡ Ø³ØªÙˆÙ† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù‡ */

                var allGood = true;
                var msg = '';

                for (var tblName in EXPECTED_SCHEMA) {
                    var cols = EXPECTED_SCHEMA[tblName];
                    var selectStr = cols.join(',');

                    var res = await sbClient.from(tblName).select(selectStr).limit(0);

                    if (res.error) {
                        msg += 'âŒ ' + tblName + ': ' + res.error.message.slice(0, 80) + '\n';
                        allGood = false;
                    } else {
                        msg += 'âœ… ' + tblName + ': Ù‡Ù…Ù‡ ' + cols.length + ' Ø³ØªÙˆÙ† ØªØ£ÛŒÛŒØ¯ Ø´Ø¯\n';
                    }
                }

                if (allGood) {
                    setStatus(6, 'pass', 'âœ… Ù…ÙˆÙÙ‚');
                    setDetail(6, 'ğŸ“ Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø³ØªÙˆÙ†â€ŒÙ‡Ø§:\n' + msg);
                } else {
                    setStatus(6, 'fail', 'âŒ Ø®Ø·Ø§');
                    setDetail(6, 'ğŸ“ Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø³ØªÙˆÙ†â€ŒÙ‡Ø§:\n' + msg);
                }

                return allGood;

            } catch (err) {
                setStatus(6, 'fail', 'âŒ Ø®Ø·Ø§');
                setDetail(6, 'âŒ ' + err.message);
                return false;
            }
        }

        /* ===========================================
         *  Ù†Ù…Ø§ÛŒØ´ Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯Ø§ÙˆÙ„ (Ø²ÛŒØ¨Ø§)
         * =========================================== */
        function renderSchema() {
            var section = document.getElementById('schemaSection');
            var html = '<div style="text-align:center;margin:20px 0 15px"><span style="font-size:1.2rem;font-weight:700;color:#4a3f6b">ğŸ“ Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯Ø§ÙˆÙ„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³</span></div>';

            var typeColors = {
                'uuid': 'uuid', 'text': 'text', 'integer': 'int',
                'boolean': 'bool', 'date': 'date', 'timestamp with time zone': 'ts'
            };

            /* Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø§Ø² JSON Ø§ØµÙ„ÛŒ */
            var schemaData = {
                users: [
                    { col: 'id', type: 'uuid', nullable: 'NO', def: 'gen_random_uuid()' },
                    { col: 'created_at', type: 'timestamptz', nullable: 'NO', def: 'now()' },
                    { col: 'email', type: 'text', nullable: 'NO', def: 'â€”' },
                    { col: 'full_name', type: 'text', nullable: 'YES', def: 'â€”' },
                    { col: 'avatar_url', type: 'text', nullable: 'YES', def: 'â€”' }
                ],
                study_logs: [
                    { col: 'id', type: 'uuid', nullable: 'NO', def: 'gen_random_uuid()' },
                    { col: 'user_id', type: 'uuid', nullable: 'YES', def: 'â€”' },
                    { col: 'subject', type: 'text', nullable: 'YES', def: 'â€”' },
                    { col: 'duration_minutes', type: 'integer', nullable: 'YES', def: '0' },
                    { col: 'study_date', type: 'date', nullable: 'YES', def: 'now()' },
                    { col: 'note', type: 'text', nullable: 'YES', def: 'â€”' },
                    { col: 'created_at', type: 'timestamptz', nullable: 'NO', def: 'now()' },
                    { col: 'notes', type: 'text', nullable: 'YES', def: 'â€”' }
                ],
                plans: [
                    { col: 'id', type: 'uuid', nullable: 'NO', def: 'gen_random_uuid()' },
                    { col: 'user_id', type: 'uuid', nullable: 'YES', def: 'â€”' },
                    { col: 'title', type: 'text', nullable: 'YES', def: 'â€”' },
                    { col: 'description', type: 'text', nullable: 'YES', def: 'â€”' },
                    { col: 'start_date', type: 'date', nullable: 'YES', def: 'â€”' },
                    { col: 'end_date', type: 'date', nullable: 'YES', def: 'â€”' },
                    { col: 'is_active', type: 'boolean', nullable: 'YES', def: 'true' },
                    { col: 'created_at', type: 'timestamptz', nullable: 'NO', def: 'now()' }
                ],
                goals: [
                    { col: 'id', type: 'uuid', nullable: 'NO', def: 'gen_random_uuid()' },
                    { col: 'user_id', type: 'uuid', nullable: 'YES', def: 'â€”' },
                    { col: 'title', type: 'text', nullable: 'YES', def: 'â€”' },
                    { col: 'target_hours', type: 'integer', nullable: 'YES', def: '0' },
                    { col: 'current_hours', type: 'integer', nullable: 'YES', def: '0' },
                    { col: 'deadline', type: 'date', nullable: 'YES', def: 'â€”' },
                    { col: 'is_completed', type: 'boolean', nullable: 'YES', def: 'false' },
                    { col: 'created_at', type: 'timestamptz', nullable: 'NO', def: 'now()' }
                ]
            };

            var tableEmojis = { users: 'ğŸ‘¤', study_logs: 'ğŸ“–', plans: 'ğŸ“…', goals: 'ğŸ¯' };

            for (var tbl in schemaData) {
                html += '<div class="schema-table-title">' + (tableEmojis[tbl] || 'ğŸ“‹') + ' ' + tbl + ' (' + schemaData[tbl].length + ' Ø³ØªÙˆÙ†)</div>';
                html += '<table class="schema-table"><thead><tr>';
                html += '<th>Ø³ØªÙˆÙ†</th><th>Ù†ÙˆØ¹</th><th>Nullable</th><th>Ù¾ÛŒØ´â€ŒÙØ±Ø¶</th>';
                html += '</tr></thead><tbody>';

                for (var j = 0; j < schemaData[tbl].length; j++) {
                    var r = schemaData[tbl][j];
                    var shortType = r.type.replace('timestamp with time zone', 'timestamptz');
                    var colorClass = 'type-text';
                    if (shortType.indexOf('uuid') >= 0) colorClass = 'type-uuid';
                    else if (shortType.indexOf('int') >= 0) colorClass = 'type-int';
                    else if (shortType.indexOf('bool') >= 0) colorClass = 'type-bool';
                    else if (shortType === 'date') colorClass = 'type-date';
                    else if (shortType.indexOf('timestamp') >= 0) colorClass = 'type-ts';

                    html += '<tr>';
                    html += '<td><strong>' + r.col + '</strong></td>';
                    html += '<td><span class="type-badge ' + colorClass + '">' + shortType + '</span></td>';
                    html += '<td>' + (r.nullable === 'NO' ? 'âŒ' : 'âœ…') + '</td>';
                    html += '<td style="font-size:0.78rem;color:#9b8fc4">' + r.def + '</td>';
                    html += '</tr>';
                }

                html += '</tbody></table>';
            }

            section.innerHTML = html;
            section.classList.add('visible');
        }

        /* ===========================================
         *  Ù†Ù…Ø§ÛŒØ´ Ø®Ù„Ø§ØµÙ‡
         * =========================================== */
        function showSummary(passed, total) {
            var summary = document.getElementById('summary');
            var scoreEl = document.getElementById('scoreDisplay');
            var titleEl = document.getElementById('summaryTitle');
            var detailEl = document.getElementById('summaryDetail');

            scoreEl.textContent = passed + ' / ' + total;

            if (passed === total) {
                scoreEl.className = 'score-display perfect';
                titleEl.textContent = 'ğŸ‰ Ø¹Ø§Ù„ÛŒ! Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ Ù¾Ø§Ø³ Ø´Ø¯Ù†!';
                detailEl.innerHTML = 'âœ… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¨Ø±Ù‚Ø±Ø§Ø±Ù‡!<br>âœ… ØªÙ…Ø§Ù… Ø¬Ø¯Ø§ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ùˆ ØµØ­ÛŒØ­ Ù‡Ø³ØªÙ†<br>âœ… Ø³Ø§Ø®ØªØ§Ø± Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯<br>âœ… RLS ÙØ¹Ø§Ù„Ù‡<br><br>ğŸš€ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ StudyKit!';
            } else if (passed >= total - 1) {
                scoreEl.className = 'score-display good';
                titleEl.textContent = 'ğŸ‘ Ø®ÙˆØ¨Ù‡! ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ù‡Ù…Ù‡ Ú†ÛŒ Ø§ÙˆÚ©ÛŒÙ‡';
                detailEl.innerHTML = 'ÙÙ‚Ø· ' + (total - passed) + ' ØªØ³Øª Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ù‡.<br>Ø¬Ø²Ø¦ÛŒØ§Øª Ø±Ùˆ Ø¨Ø§Ù„Ø§ Ø¨Ø¨ÛŒÙ† Ùˆ Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø¯Ù‡!';
            } else {
                scoreEl.className = 'score-display bad';
                titleEl.textContent = 'âš ï¸ Ù…Ø´Ú©Ù„Ø§ØªÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡';
                detailEl.innerHTML = (total - passed) + ' ØªØ³Øª Ø±Ø¯ Ø´Ø¯!<br>Ø¬Ø²Ø¦ÛŒØ§Øª Ø±Ùˆ Ø¨Ø§Ù„Ø§ Ø¨Ø¨ÛŒÙ†.';
            }

            summary.classList.add('visible');
        }

        /* ===========================================
         *  Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§
         * =========================================== */
        async function runAllTests() {
            var btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§...';

            testResults = [];

            /* ØªØ³Øª Û± */
            var r1 = await runTest1();
            testResults.push(r1);
            if (!r1) {
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯';
                showSummary(0, 6);
                return;
            }

            /* ØªØ³Øª Û² */
            var r2 = await runTest2();
            testResults.push(r2);

            /* ØªØ³Øª Û³ */
            var r3 = await runTest3();
            testResults.push(r3);

            /* ØªØ³Øª Û´ */
            var r4 = await runTest4();
            testResults.push(r4);

            /* ØªØ³Øª Ûµ */
            var r5 = await runTest5();
            testResults.push(r5);

            /* ØªØ³Øª Û¶ */
            var r6 = await runTest6();
            testResults.push(r6);

            /* Ù†Ù…Ø§ÛŒØ´ Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯Ø§ÙˆÙ„ */
            renderSchema();

            /* Ø®Ù„Ø§ØµÙ‡ */
            var passedCount = testResults.filter(function (v) { return v === true; }).length;
            showSummary(passedCount, testResults.length);

            btn.disabled = false;
            btn.textContent = 'ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ ØªØ³Øªâ€ŒÙ‡Ø§';
        }

        /* ---------- Ø±ÙˆÛŒØ¯Ø§Ø¯ Ú©Ù„ÛŒÚ© ---------- */
        document.getElementById('startBtn').addEventListener('click', runAllTests);
    </script>

</body>
</html>
